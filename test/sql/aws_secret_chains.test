# name: test/sql/aws_secret_chains.test
# description: test aws extension with different chain configs
# group: [sql]

require aws

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

# Note this test is not very intelligent since we dont assume any profiles to be available

statement ok
set secret_directory='__TEST_DIR__/aws_secret_chains'

statement ok
CREATE SECRET config_no_profile (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'config'
);

query I
SELECT secret_string FROM duckdb_secrets(redact=false) where name='config_no_profile';
----
<REGEX>:.*endpoint=s3.amazonaws.com.*

statement ok
CREATE SECRET config_with_profile (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'config',
    PROFILE 'minio-testing-2'
);

# cannot use sts chain without providing an assume_role_arn.
# sts takes place automatically if role-arn is provided for the provile in the config
statement error
CREATE SECRET sts_secret (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'sts'
);
----
<REGEX>:.*Invalid Configuration Error: Chain value 'STS' is only supported with an ASSUME_ROLE_ARN value.*

statement error
CREATE SECRET sso_secret_no_profile (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'sso'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: during `generate` using the following:
Credential Chain: 'sso'.*

# same as above, !validation
statement ok
CREATE SECRET sso_secret_no_profile (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'sso',
	VALIDATION 'none'
);

statement error
CREATE SECRET sso_secret_with_profile (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'sso',
    PROFILE 'minio-testing-2'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: during `generate` using the following:
Profile: 'minio-testing-2'
Credential Chain: 'sso'.*

# same as above, !validation
statement ok
CREATE SECRET sso_secret_with_profile (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'sso',
    PROFILE 'minio-testing-2',
	VALIDATION 'none'
);

statement error
CREATE SECRET env_secret (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'env'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: during `create` using the following:
Credential Chain: 'env'.*

# same as above, !validation
statement ok
CREATE SECRET env_secret (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'env',
	VALIDATION 'none'
);
