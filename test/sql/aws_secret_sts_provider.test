# name: test/sql/aws_secret_sts_provider.test
# description: test getting a secret via a profile that does sts
# group: [sql]

require aws

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

statement error
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'config',
    PROFILE 'assume-role-arn-does-not-exist'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: no profile 'assume-role-arn-does-not-exist' found.*

# same as above, !validation
statement ok
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    CHAIN 'config',
    PROFILE 'assume-role-arn-does-not-exist',
	VALIDATION 'none'
);

# can't create the credentials because we don't have a service to provide credentials via sts
# profile assume-role-arn has an assume role. So sts provider is used.
# this should be the most common way to use sts roles, with the role defined in the credentials config
statement error
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'assume-role-arn'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: during `create` using the following:
Profile: 'assume-role-arn'
Credential Chain: 'config'.*

# 'sts' in the chain is still allowed for legacy reasons
# The STSProvider will try to find a profile that assumes a role and return credentials
# for that role
statement error
CREATE or replace SECRET sts_secret (
    TYPE S3,
    PROVIDER credential_chain,
    ASSUME_ROLE_ARN 'arn:aws:iam::840140254803:role/pyiceberg-etl-role',
    CHAIN 'sts'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: during `generate` using the following:
Credential Chain: 'sts'
Role-arn: 'arn:aws:iam::840140254803:role/pyiceberg-etl-role'.*

# same as above, !validation
statement ok
CREATE or replace SECRET sts_secret (
    TYPE S3,
    PROVIDER credential_chain,
    ASSUME_ROLE_ARN 'arn:aws:iam::840140254803:role/pyiceberg-etl-role',
    CHAIN 'sts',
	VALIDATION 'none'
);

# STS provider is used due to presence of 'assume_role_arn'.
# test fails because ASSUME_ROLE_ARN also needs a chain (either 'sts' or 'config')
statement error
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'default',
    ASSUME_ROLE_ARN 'arn:aws:iam::840140254803:role/pyiceberg-etl-role'
);
----
<REGEX>:.*Must pass CHAIN value when passing ASSUME_ROLE_ARN.*

# STS provider assumed due to 'assume_role_arn'.
# test fails because we can't create the credentials with no test service to provide credentials via sts
statement error
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'assume-role-arn',
    ASSUME_ROLE_ARN 'arn:aws:iam::840140254803:role/pyiceberg-etl-role'
);
----
<REGEX>:.*Must pass CHAIN value when passing ASSUME_ROLE_ARN.*

# STS provider assumed due to 'assume_role_arn'.
# test fails because we can't create the credentials with no test service to provide credentials via sts
statement error
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'assume-role-arn',
    ASSUME_ROLE_ARN 'arn:aws:iam::840140254803:role/pyiceberg-etl-role'
);
----
<REGEX>:.*Must pass CHAIN value when passing ASSUME_ROLE_ARN.*

statement error
CREATE or replace SECRET assume_role (
    TYPE S3,
    PROVIDER credential_chain,
    external_id '2389238923',
    PROFILE 'assume-role-arn-external-id'
);
----
<REGEX>:.*Invalid Input Error: Ambiguous external id.*
