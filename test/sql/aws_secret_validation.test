# name: test/sql/settings/aws_secret_validation_present.test
# description: Test that SET secret_validation works
# group: [sql]

require aws

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

# Without params, 'exists' check must pass using secret_directory
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain
);

# Explicit 'exists' check must pass using secret_directory
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    VALIDATION 'exists'
);

# Explicit 'none' check must also pass
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    VALIDATION 'none'
);

#### Use non existent profile to force no available credentials

# bad validation param
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
	PROFILE 'minio-testing-empty',
    VALIDATION 'none'
);

# validation param specified correctly, no credential found to exist
statement error
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
	PROFILE 'minio-testing-empty',
    VALIDATION 'exists'
);
----
Invalid Input Error: Failed to create secret

# validation param specified correctly, no credential found to exist
statement error
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
	PROFILE 'minio-testing-empty',
    VALIDATION 'nonsense'
);
----
Invalid Configuration Error: Unknown AWS VALIDATION option
