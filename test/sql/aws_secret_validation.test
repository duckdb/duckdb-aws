# name: test/sql/settings/aws_secret_validation_present.test
# description: Test that SET secret_validation works
# group: [sql]

require aws

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

##
# NOTE: for context, these tests are run in the presence of valid .aws/{config,credentials} 
# files, so default chains will find valid secret[s], depending on profile and other settings.
#

# Without params, 'exists' applied
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain
);

# Explicit 'exists' same as unspecified
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    VALIDATION 'exists'
);

# Explicit 'none' check must also pass
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    VALIDATION 'none'
);

#### Confirm also with legit explicit profile

# Without params, default 'exists'
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'minio-testing-2'
);

# Explicit 'exists' check 
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'minio-testing-2',
    VALIDATION 'exists'
);

# Explicit 'none' check must also pass
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'minio-testing-2',
    VALIDATION 'none'
);


#### Use legit but non empty profile to force no available credentials

# validation off -> ok
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'minio-testing-empty',
    VALIDATION 'none'
);

# validation -> err
statement error
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'minio-testing-empty',
    VALIDATION 'exists'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: during.*

# validation param invalid err >> empty profile
statement error
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'minio-testing-empty',
    VALIDATION 'nonsense'
);
----
<REGEX>:.*Invalid Input Error: Unknown AWS validation mode.*


#### non-existent profile

# bad profile but validation off -> ok
statement ok
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'no-such-profile',
    VALIDATION 'none'
);

# bad profile + validation -> err
statement error
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'no-such-profile',
    VALIDATION 'exists'
);
----
<REGEX>:.*Invalid Configuration Error: Secret Validation Failure: no profile.*

# invalid validation param >> invalid profile
statement error
CREATE OR REPLACE SECRET aws (
    TYPE S3,
    PROVIDER credential_chain,
    PROFILE 'no-such-profile',
    VALIDATION 'nonsense'
);
----
<REGEX>:.*Invalid Input Error: Unknown AWS validation mode.*
